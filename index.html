<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Moonlight Mosaic - 我们的月光拼图</title>
    <!-- 引入 React 和 ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- 引入 Babel 用于解析 JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        /* 禁止默认的触摸行为，防止双击缩放等干扰游戏 */
        body {
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            overflow: hidden;
            background-color: #0f172a; /* Slate 900 */
            color: #f8fafc;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        }
        
        /* 定制求婚字体 */
        .font-proposal {
            font-family: "Times New Roman", "KaiTi", "STKaiti", "BiauKai", serif;
        }

        /* 自定义月亮光晕动画 */
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px 5px rgba(253, 224, 71, 0.3); }
            50% { box-shadow: 0 0 40px 10px rgba(253, 224, 71, 0.6); }
        }
        
        .moon-glow {
            animation: pulse-glow 4s infinite ease-in-out;
        }

        /* 碎片飞入动画 */
        @keyframes fly-in {
            0% { transform: scale(3) translate(0, 50vh); opacity: 0; }
            100% { transform: scale(1) translate(0, 0); opacity: 1; }
        }
        .shard-animate {
            animation: fly-in 1.5s cubic-bezier(0.22, 1, 0.36, 1) forwards;
        }
        
        /* 简单的闪烁动画 */
        .blink {
            animation: blinker 1s linear infinite;
        }
        @keyframes blinker {
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 游戏数据与配置 ---
        
        // 求婚誓词配置
        const PROPOSAL_TEXT = {
            title: "亲爱的",
            body: "和你一起度过的每一关，都是我生命中最美好的时光。\n\n我们在游戏中配合默契，在生活中相互扶持。\n\n这轮圆满的月亮，代表我对你圆满的爱。",
            question: "你愿意嫁给我吗？"
        };

        // 升级版单词库 (TOEFL / 高级词汇)
        // logic: 'controller' 决定每一轮谁拿键盘 (1=左边玩家, 2=右边玩家)
        const WORD_PUZZLES = [
            { 
                word: "SERENDIPITY", 
                hintPattern: [true, false, true, false, true, false, true, false, true, false, true], // true显示, false隐藏
                options: ["S", "E", "R", "N", "D", "I", "P", "T", "Y", "A"], 
                definition: "【名】机缘巧合，意外发现珍宝的运气",
                example: "It was pure ______ that we met at the coffee shop that day.",
                startPlayer: 2 // 第一关右边操作键盘
            },
            { 
                word: "CHERISH", 
                hintPattern: [false, true, false, true, false, true, false], 
                options: ["C", "H", "E", "R", "I", "S", "A", "T"], 
                definition: "【动】珍爱，爱护 (to protect and care for lovingly)",
                example: "I will ______ every moment we spend together.",
                startPlayer: 1 // 第二关左边操作键盘 (轮换)
            },
            { 
                word: "RESILIENT", 
                hintPattern: [true, false, false, true, false, true, false, true, false], 
                options: ["R", "E", "S", "I", "L", "N", "T", "M"], 
                definition: "【形】有弹性的；(关系) 坚韧的，经得起考验的",
                example: "Our love is ______, able to withstand any challenge.",
                startPlayer: 2 // 轮换回右边
            },
            {
                word: "ETERNAL",
                hintPattern: [false, true, false, true, false, true, false],
                options: ["E", "T", "R", "N", "A", "L", "S", "O"],
                definition: "【形】永恒的，不朽的 (lasting or existing forever)",
                example: "I promise you my ______ love.",
                startPlayer: 1 // 轮换回左边
            }
        ];

        // --- 通用组件 ---

        // Debug按钮组件
        const DebugButton = ({ onClick }) => (
            <button 
                onClick={(e) => { e.stopPropagation(); onClick(); }}
                className="absolute top-2 right-2 px-2 py-1 bg-red-900/20 text-red-500/30 text-xs rounded hover:bg-red-900 hover:text-white z-50 border border-transparent hover:border-red-500"
            >
                DEBUG: Pass
            </button>
        );

        // 1. 月亮进度展示组件
        const MoonDisplay = ({ progress, isFull }) => {
            return (
                <div className={`relative w-48 h-48 transition-all duration-1000 ${isFull ? 'scale-150 moon-glow' : ''}`}>
                    <svg viewBox="0 0 100 100" className="w-full h-full drop-shadow-2xl">
                        <defs>
                            <filter id="glow">
                                <feGaussianBlur stdDeviation="2.5" result="coloredBlur"/>
                                <feMerge>
                                    <feMergeNode in="coloredBlur"/>
                                    <feMergeNode in="SourceGraphic"/>
                                </feMerge>
                            </filter>
                        </defs>
                        <circle cx="50" cy="50" r="45" fill="#1e293b" stroke="#334155" strokeWidth="1" />
                        <g>
                             <circle cx="50" cy="50" r="45" fill="#fde047" filter="url(#glow)" 
                                style={{
                                    clipPath: `inset(0% ${100 - (progress * 100)}% 0% 0%)`,
                                    transition: 'clip-path 1.5s ease-in-out'
                                }}
                             />
                        </g>
                        <circle cx="30" cy="40" r="5" fill="rgba(0,0,0,0.1)" />
                        <circle cx="60" cy="70" r="8" fill="rgba(0,0,0,0.1)" />
                        <circle cx="70" cy="30" r="4" fill="rgba(0,0,0,0.1)" />
                    </svg>
                </div>
            );
        };

        // 2. 游戏 1: 单词心灵感应 (升级版 - 交替控制)
        const GameWordPuzzle = ({ onComplete }) => {
            const [currentRound, setCurrentRound] = useState(0);
            const [selectedChars, setSelectedChars] = useState([]);
            const [feedback, setFeedback] = useState(""); 

            const puzzle = WORD_PUZZLES[currentRound];
            
            // 谁在操作键盘？
            const isP1Controlling = puzzle.startPlayer === 1;

            const handleCharClick = (char) => {
                const newSelection = [...selectedChars, char];
                setSelectedChars(newSelection);

                if (newSelection.length === puzzle.word.length) {
                    const attempt = newSelection.join("");
                    if (attempt === puzzle.word) {
                        setFeedback("correct");
                        setTimeout(() => {
                            if (currentRound < WORD_PUZZLES.length - 1) {
                                setCurrentRound(c => c + 1);
                                setSelectedChars([]);
                                setFeedback("");
                            } else {
                                onComplete();
                            }
                        }, 1500);
                    } else {
                        setFeedback("wrong");
                        setTimeout(() => {
                            setSelectedChars([]);
                            setFeedback("");
                        }, 800);
                    }
                }
            };

            const debugPass = () => {
                // 自动填入正确答案
                setSelectedChars(puzzle.word.split(''));
                setFeedback("correct");
                setTimeout(() => {
                    if (currentRound < WORD_PUZZLES.length - 1) {
                        setCurrentRound(c => c + 1);
                        setSelectedChars([]);
                        setFeedback("");
                    } else {
                        onComplete();
                    }
                }, 1000);
            };

            // 生成展示用的Hint字符串 (将单词根据 pattern 遮挡)
            const getDisplayWord = (fullWord, pattern, forController) => {
                // Controller 看到的是填空界面，Hinter 看到的是残缺提示
                // 为了增加合作，Hinter看到 Controller 看不到的部分
                return fullWord.split('').map((char, i) => {
                    // 如果是给Controller看，已选的字母显示，未选的显示空
                    if (forController) return "_"; 
                    // 如果是给 Hinter 看，显示 pattern 为 true 的部分，或者显示全部 hint
                    return pattern[i] ? char : "_";
                }).join(" ");
            };

            // 提示界面组件 (显示给没有键盘的人)
            const HintPanel = ({ puzzle }) => (
                <div className="flex flex-col items-center justify-center h-full px-12 text-center">
                    <h3 className="text-xl text-yellow-500 mb-2 font-bold">你的任务: 提示搭档</h3>
                    <div className="text-sm text-slate-400 mb-6">描述这个单词，或者告诉Ta缺什么字母</div>
                    
                    {/* 显示带缺口的单词提示 */}
                    <div className="text-5xl font-mono tracking-widest text-slate-200 mb-8">
                        {puzzle.word.split('').map((c, i) => puzzle.hintPattern[i] ? c : "_").join(" ")}
                    </div>

                    {/* 学习区域 */}
                    <div className="bg-slate-800/50 p-6 rounded-xl border border-slate-700 w-full">
                        <div className="text-lg text-yellow-100 font-serif mb-2">{puzzle.definition}</div>
                        <div className="text-slate-400 italic">"{puzzle.example}"</div>
                    </div>
                </div>
            );

            // 操作界面组件 (显示给有键盘的人)
            const ControlPanel = ({ puzzle, currentInput, feedback, onInput }) => (
                <div className="flex flex-col items-center justify-center h-full px-8 relative">
                    <h3 className="text-xl text-green-400 mb-4 font-bold">你的任务: 拼写单词</h3>
                    
                    {/* 输入框 */}
                    <div className={`mb-8 h-16 flex items-center justify-center text-4xl font-bold tracking-widest border-b-4 transition-colors w-full ${feedback === 'wrong' ? 'border-red-500 text-red-400' : (feedback === 'correct' ? 'border-green-500 text-green-400' : 'border-slate-500')}`}>
                        {currentInput.length > 0 ? currentInput.join(" ") : <span className="text-slate-700 animate-pulse">等待输入...</span>}
                    </div>

                    {/* 键盘 */}
                    <div className="grid grid-cols-5 gap-3 w-full max-w-lg">
                        {puzzle.options.map((char, idx) => (
                            <button 
                                key={idx}
                                className="aspect-square bg-slate-700 rounded-lg text-2xl font-bold active:bg-yellow-500 active:scale-95 transition-all shadow-lg border-b-4 border-slate-950 hover:bg-slate-600"
                                onClick={() => onInput(char)}
                            >
                                {char}
                            </button>
                        ))}
                        <button 
                            className="aspect-square col-span-1 bg-red-900/50 rounded-lg text-xl flex items-center justify-center active:scale-95 transition-all border-b-4 border-red-950 hover:bg-red-900/70"
                            onClick={() => setSelectedChars(prev => prev.slice(0, -1))}
                        >
                            <i className="ph ph-backspace"></i>
                        </button>
                    </div>
                </div>
            );

            return (
                <div className="flex w-full h-full relative">
                    <DebugButton onClick={debugPass} />
                    
                    {/* 左侧区域 */}
                    <div className="w-1/2 border-r border-slate-700 bg-slate-900 relative">
                        {isP1Controlling ? (
                            <ControlPanel 
                                puzzle={puzzle} 
                                currentInput={selectedChars} 
                                feedback={feedback} 
                                onInput={handleCharClick} 
                            />
                        ) : (
                            <HintPanel puzzle={puzzle} />
                        )}
                        <div className="absolute top-4 left-4 text-xs font-bold text-slate-600">PLAYER 1</div>
                    </div>

                    {/* 右侧区域 */}
                    <div className="w-1/2 bg-slate-800 relative">
                        {!isP1Controlling ? (
                             <ControlPanel 
                                puzzle={puzzle} 
                                currentInput={selectedChars} 
                                feedback={feedback} 
                                onInput={handleCharClick} 
                            />
                        ) : (
                            <HintPanel puzzle={puzzle} />
                        )}
                        <div className="absolute top-4 right-4 text-xs font-bold text-slate-600">PLAYER 2</div>
                    </div>
                </div>
            );
        };

        // 3. 游戏 2: 同步共振 (保持不变，增加调试)
        const GameSyncReaction = ({ onComplete }) => {
            const [gameState, setGameState] = useState("waiting");
            const [count, setCount] = useState(3);
            const [p1Ready, setP1Ready] = useState(false);
            const [p2Ready, setP2Ready] = useState(false);

            useEffect(() => {
                if (p1Ready && p2Ready && gameState === "waiting") {
                    setGameState("counting");
                    let c = 3;
                    setCount(c);
                    const timer = setInterval(() => {
                        c--;
                        setCount(c);
                        if (c <= 0) {
                            clearInterval(timer);
                            setGameState("active");
                        }
                    }, 1000);
                }
            }, [p1Ready, p2Ready, gameState]);

            const handleTouch = (player) => {
                if (gameState !== "active") return;
                if (player === 1) setP1Ready(false);
                if (player === 2) setP2Ready(false);
                 setGameState("success");
                 setTimeout(onComplete, 1500);
            };

            const debugPass = () => {
                setGameState("success");
                setTimeout(onComplete, 1000);
            };

            return (
                <div className="flex w-full h-full relative">
                     <DebugButton onClick={debugPass} />
                     <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-10 pointer-events-none text-center w-full">
                        {gameState === "waiting" && <div className="text-2xl bg-black/60 px-8 py-4 rounded-full backdrop-blur border border-white/10 text-white">两人同时按住按钮充能</div>}
                        {gameState === "counting" && <div className="text-[12rem] font-bold text-yellow-400 scale-animate leading-none">{count}</div>}
                        {gameState === "active" && <div className="text-8xl font-black text-green-400 tracking-tighter animate-pulse">TAP NOW!</div>}
                        {gameState === "success" && <div className="text-5xl font-bold text-yellow-400 font-proposal">Perfect Harmony</div>}
                    </div>

                    <div 
                        className={`w-1/2 border-r border-slate-700 flex items-center justify-center transition-colors duration-300 ${gameState === 'success' ? 'bg-green-900' : 'bg-slate-900'}`}
                        onTouchStart={() => gameState === 'active' ? handleTouch(1) : setP1Ready(true)}
                        onMouseDown={() => gameState === 'active' ? handleTouch(1) : setP1Ready(true)}
                        onMouseUp={() => gameState === 'waiting' && setP1Ready(false)}
                        onTouchEnd={() => gameState === 'waiting' && setP1Ready(false)}
                    >
                        <div className={`w-64 h-64 rounded-full border-8 flex items-center justify-center transition-all duration-300 cursor-pointer ${p1Ready ? 'border-yellow-400 bg-yellow-400/20 scale-105 shadow-[0_0_50px_rgba(250,204,21,0.5)]' : 'border-slate-700 hover:border-slate-500'}`}>
                            <i className={`ph ph-fingerprint text-8xl transition-all ${p1Ready ? 'text-yellow-400 opacity-100' : 'text-slate-600 opacity-50'}`}></i>
                        </div>
                    </div>

                    <div 
                        className={`w-1/2 flex items-center justify-center transition-colors duration-300 ${gameState === 'success' ? 'bg-green-900' : 'bg-slate-800'}`}
                        onTouchStart={() => gameState === 'active' ? handleTouch(2) : setP2Ready(true)}
                        onMouseDown={() => gameState === 'active' ? handleTouch(2) : setP2Ready(true)}
                        onMouseUp={() => gameState === 'waiting' && setP2Ready(false)}
                        onTouchEnd={() => gameState === 'waiting' && setP2Ready(false)}
                    >
                        <div className={`w-64 h-64 rounded-full border-8 flex items-center justify-center transition-all duration-300 cursor-pointer ${p2Ready ? 'border-yellow-400 bg-yellow-400/20 scale-105 shadow-[0_0_50px_rgba(250,204,21,0.5)]' : 'border-slate-700 hover:border-slate-500'}`}>
                             <i className={`ph ph-fingerprint text-8xl transition-all ${p2Ready ? 'text-yellow-400 opacity-100' : 'text-slate-600 opacity-50'}`}></i>
                        </div>
                    </div>
                </div>
            );
        };

        // 4. 求婚结局页面 (字体优化)
        const ProposalScreen = () => {
            const [step, setStep] = useState(0);

            useEffect(() => {
                setTimeout(() => setStep(1), 1000); 
                setTimeout(() => setStep(2), 4000); 
                setTimeout(() => setStep(3), 9000); 
            }, []);

            return (
                <div className="absolute inset-0 bg-black z-50 flex flex-col items-center justify-center text-center p-8 overflow-hidden">
                    <div className="absolute inset-0 opacity-50" style={{backgroundImage: 'radial-gradient(white 1px, transparent 1px)', backgroundSize: '50px 50px'}}></div>
                    
                    <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 opacity-20 blur-3xl">
                        <div className="w-96 h-96 bg-yellow-200 rounded-full animate-pulse"></div>
                    </div>

                    <div className="relative z-10 max-w-4xl font-proposal">
                        <h1 className={`text-6xl text-yellow-100 mb-12 transition-all duration-1000 transform ${step >= 1 ? 'opacity-100 translate-y-0' : 'opacity-0 -translate-y-10'}`}>
                            {PROPOSAL_TEXT.title}
                        </h1>
                        
                        <div className={`text-3xl leading-loose text-slate-300 mb-16 whitespace-pre-line transition-all duration-1000 delay-300 ${step >= 2 ? 'opacity-100' : 'opacity-0'}`}>
                            {PROPOSAL_TEXT.body}
                        </div>

                        <div className={`transition-all duration-1000 transform ${step >= 3 ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-10'}`}>
                             <h2 className="text-5xl font-bold text-white mb-16 drop-shadow-[0_0_15px_rgba(255,255,255,0.8)]">
                                {PROPOSAL_TEXT.question}
                            </h2>
                            
                            <div className="flex gap-8 justify-center">
                                <button className="px-16 py-6 bg-yellow-500 text-yellow-950 rounded-full text-3xl font-bold shadow-[0_0_40px_rgba(234,179,8,0.6)] active:scale-95 transition-transform animate-bounce font-sans">
                                    YES, I DO!
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 主程序 App ---
        const App = () => {
            const [gameStage, setGameStage] = useState("menu"); 
            const [level, setLevel] = useState(1);
            const [moonProgress, setMoonProgress] = useState(0); 
            
            const TOTAL_LEVELS = 2; 

            const startGame = () => {
                setGameStage("playing");
            };

            const handleLevelComplete = () => {
                setGameStage("transition");
                const newProgress = level / TOTAL_LEVELS;
                setMoonProgress(newProgress);

                setTimeout(() => {
                    if (level < TOTAL_LEVELS) {
                        setLevel(l => l + 1);
                        setGameStage("playing");
                    } else {
                        setGameStage("ending");
                    }
                }, 4000); 
            };

            // 强制横屏检查提示
            const [isLandscape, setIsLandscape] = useState(window.innerWidth > window.innerHeight);
            useEffect(() => {
                const checkOrientation = () => setIsLandscape(window.innerWidth > window.innerHeight);
                window.addEventListener('resize', checkOrientation);
                return () => window.removeEventListener('resize', checkOrientation);
            }, []);

            if (!isLandscape) {
                return (
                    <div className="w-screen h-screen bg-black flex flex-col items-center justify-center text-white p-8 text-center">
                        <i className="ph ph-device-rotate text-6xl mb-4 animate-spin-slow"></i>
                        <h2 className="text-xl">请旋转 iPad 至横屏模式以获得最佳体验</h2>
                    </div>
                );
            }

            return (
                <div className="w-screen h-screen bg-slate-900 flex flex-col overflow-hidden">
                    {/* 顶部状态栏 */}
                    <div className="h-16 border-b border-slate-800 flex items-center justify-between px-8 bg-slate-950/50 backdrop-blur z-20">
                        <div className="text-slate-400 text-sm font-bold tracking-widest">MOONLIGHT MOSAIC</div>
                        <div className="text-yellow-500 font-serif italic">Level {level} / {TOTAL_LEVELS}</div>
                    </div>

                    <div className="flex-1 relative">
                        {gameStage === "menu" && (
                            <div className="absolute inset-0 flex flex-col items-center justify-center z-50 bg-slate-900/90">
                                <MoonDisplay progress={0} isFull={false} />
                                <h1 className="text-7xl font-thin text-white mt-8 mb-4 tracking-tighter font-serif">月光拼图</h1>
                                <p className="text-slate-400 mb-12 text-xl font-proposal">双人合作 · 学习 · 见证爱</p>
                                <button 
                                    onClick={startGame}
                                    className="px-12 py-5 border border-yellow-500/50 text-yellow-400 rounded-full hover:bg-yellow-500/10 hover:border-yellow-400 transition-all text-2xl tracking-widest"
                                >
                                    START GAME
                                </button>
                            </div>
                        )}

                        {gameStage === "transition" && (
                            <div className="absolute inset-0 flex flex-col items-center justify-center z-40 bg-slate-900/95 backdrop-blur-md transition-all duration-500">
                                <div className="text-3xl text-yellow-300 mb-12 font-proposal animate-bounce">
                                    {level === TOTAL_LEVELS ? "月亮完整了..." : "关卡完成! 收集到月光碎片"}
                                </div>
                                <div className="shard-animate">
                                    <MoonDisplay progress={moonProgress} isFull={moonProgress >= 0.99} />
                                </div>
                            </div>
                        )}

                        {gameStage === "playing" && (
                            <div className="w-full h-full">
                                {level === 1 && <GameWordPuzzle onComplete={handleLevelComplete} />}
                                {level === 2 && <GameSyncReaction onComplete={handleLevelComplete} />}
                            </div>
                        )}

                        {gameStage === "ending" && (
                            <ProposalScreen />
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>