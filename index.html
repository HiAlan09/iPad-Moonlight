<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-touch-fullscreen" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Moonlight Mosaic">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==">
    
    <title>Moonlight Mosaic - 我们的月光拼图</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        body {
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            overflow: hidden;
            background-color: #0f172a;
            color: #f8fafc;
            font-family: 'Times New Roman', serif;
            padding-top: env(safe-area-inset-top);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
            padding-bottom: env(safe-area-inset-bottom);
        }
        .font-sans-custom { font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; }
        .font-proposal-cn { font-family: "KaiTi", "STKaiti", "BiauKai", "楷体", serif; }
        .font-proposal-en { font-family: "Times New Roman", serif; }
        .stars { background: #000 url('https://raw.githubusercontent.com/hyshin/star-background/master/stars.png') repeat top center; z-index: 0; }
        .twinkling { background: transparent url('https://raw.githubusercontent.com/hyshin/star-background/master/twinkling.png') repeat top center; z-index: 1; animation: move-twink-back 200s linear infinite; opacity: 0.6; }
        @keyframes move-twink-back { from {background-position:0 0;} to {background-position:-10000px 5000px;} }
        
        .scale-in { animation: scaleIn 0.3s ease-out forwards; }
        @keyframes scaleIn { from { transform: scale(0); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .animate-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        
        @keyframes ring-fly { 
            0% { transform: translate(0, 0) scale(1); opacity: 1; } 
            40% { transform: translate(15vw, -20vh) scale(1.2); opacity: 1; } 
            100% { transform: translate(25vw, 15vh) scale(0); opacity: 0; } 
        }
        .animate-ring-fly { animation: ring-fly 1.5s ease-in-out forwards; }

        /* 棋盘格线样式 */
        .radar-board {
            display: grid;
            gap: 1px;
            background-color: #7f1d1d; /* 红色网格线 */
            border: 2px solid #ef4444;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.3);
            padding: 2px;
            border-radius: 0.5rem;
        }
        .radar-cell {
            background-color: #1a0505;
        }

        .pilot-board {
            display: grid;
            gap: 1px;
            background-color: #475569; /* 蓝灰色网格线 */
            border: 2px solid #94a3b8;
            box-shadow: 0 0 15px rgba(148, 163, 184, 0.3);
            padding: 2px;
            border-radius: 0.5rem;
        }
        .pilot-cell {
            background-color: #0f172a;
        }
        
        .skull-jump { animation: skullJump 0.8s infinite alternate; }
        @keyframes skullJump { from { transform: translateY(0) scale(1); } to { transform: translateY(-3px) scale(1.1); } }
        .my-piece-dot { animation: radarPing 1.5s infinite; }
        @keyframes radarPing { 0% { transform: scale(0.8); opacity: 0.5; } 50% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(0.8); opacity: 0.5; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        const PROPOSAL_TEXT = {
            title: "亲爱的",
            lines: ["和你一起度过的每一关，", "都是我生命中最美好的时光。", "我们在游戏中配合默契，", "在生活中相互扶持。", "这轮圆满的月亮，", "代表我对你圆满的爱。"],
            question: "你愿意嫁给我吗？"
        };

        const WORD_LIBRARY = [
            { word: "ETERNAL", pos: "adj.", ipa: "/ɪˈtɜːnl/", def: "永恒的", ex: "I promise you my eternal love." },
            { word: "CHERISH", pos: "v.", ipa: "/ˈtʃerɪʃ/", def: "珍爱", ex: "I will cherish every moment." },
            { word: "DEVOTION", pos: "n.", ipa: "/dɪˈvəʊʃn/", def: "奉献", ex: "His devotion was obvious." },
            { word: "SERENDIPITY", pos: "n.", ipa: "/ˌserənˈdɪpəti/", def: "机缘巧合", ex: "Meeting you was serendipity." },
            { word: "HARMONY", pos: "n.", ipa: "/ˈhɑːməni/", def: "和谐", ex: "Living in perfect harmony." },
            { word: "RESILIENT", pos: "adj.", ipa: "/rɪˈzɪliənt/", def: "坚韧的", ex: "Our love is resilient." },
            { word: "ABUNDANT", pos: "adj.", ipa: "/əˈbʌndənt/", def: "丰富的", ex: "Abundant happiness." },
            { word: "BRILLIANT", pos: "adj.", ipa: "/ˈbrɪliənt/", def: "灿烂的", ex: "A brilliant future." },
            { word: "ILLUMINATE", pos: "v.", ipa: "/ɪˈluːmɪneɪt/", def: "照亮", ex: "You illuminate my world." },
            { word: "CELESTIAL", pos: "adj.", ipa: "/səˈlestiəl/", def: "神圣的", ex: "A celestial body." },
            { word: "PROSPER", pos: "v.", ipa: "/ˈprɒspə(r)/", def: "繁荣", ex: "We will prosper together." },
            { word: "GENUINE", pos: "adj.", ipa: "/ˈdʒenjuɪn/", def: "真诚的", ex: "Genuine affection." },
            { word: "DESTINY", pos: "n.", ipa: "/ˈdestɪni/", def: "命运", ex: "It was our destiny." },
            { word: "AFFECTION", pos: "n.", ipa: "/əˈfekʃn/", def: "喜爱", ex: "Deep affection." },
            { word: "GRATITUDE", pos: "n.", ipa: "/ˈɡrætɪtjuːd/", def: "感激", ex: "Eternal gratitude." },
            { word: "PASSION", pos: "n.", ipa: "/ˈpæʃn/", def: "激情", ex: "A shared passion." },
            { word: "SINCERE", pos: "adj.", ipa: "/sɪnˈsɪə(r)/", def: "真挚的", ex: "My sincere apology." },
            { word: "VIBRANT", pos: "adj.", ipa: "/ˈvaɪbrənt/", def: "充满活力的", ex: "A vibrant relationship." },
            { word: "SPLENDID", pos: "adj.", ipa: "/ˈsplendɪd/", def: "极好的", ex: "A splendid time." },
            { word: "PRECIOUS", pos: "adj.", ipa: "/ˈpreʃəs/", def: "珍贵的", ex: "Time is precious." },
            { word: "AMBIGUOUS", pos: "adj.", ipa: "/æmˈbɪɡjuəs/", def: "模棱两可的", ex: "The instructions were ambiguous." },
            { word: "BENEVOLENT", pos: "adj.", ipa: "/bəˈnevələnt/", def: "仁慈的", ex: "A benevolent leader." },
            { word: "CAPRICIOUS", pos: "adj.", ipa: "/kəˈprɪʃəs/", def: "反复无常的", ex: "The capricious weather." },
            { word: "DILIGENT", pos: "adj.", ipa: "/ˈdɪlɪdʒənt/", def: "勤勉的", ex: "A diligent student." },
            { word: "EPHEMERAL", pos: "adj.", ipa: "/ɪˈfemərəl/", def: "短暂的", ex: "Ephemeral beauty." },
            { word: "FLUCTUATE", pos: "v.", ipa: "/ˈflʌktʃueɪt/", def: "波动", ex: "Prices fluctuate wildly." },
            { word: "GREGARIOUS", pos: "adj.", ipa: "/ɡrɪˈɡeəriəs/", def: "群居的", ex: "He is a gregarious person." },
            { word: "HYPOTHESIS", pos: "n.", ipa: "/haɪˈpɒθəsɪs/", def: "假设", ex: "Test the hypothesis." },
            { word: "INEVITABLE", pos: "adj.", ipa: "/ɪnˈevɪtəbl/", def: "不可避免的", ex: "Change is inevitable." },
            { word: "JUXTAPOSE", pos: "v.", ipa: "/ˌdʒʌkstəˈpəʊz/", def: "并列放置", ex: "Juxtapose two images." },
            { word: "KINETIC", pos: "adj.", ipa: "/kɪˈnetɪk/", def: "运动的", ex: "Kinetic energy." },
            { word: "LETHARGIC", pos: "adj.", ipa: "/ləˈθɑːdʒɪk/", def: "昏睡的", ex: "Feeling lethargic today." },
            { word: "MITIGATE", pos: "v.", ipa: "/ˈmɪtɪɡeɪt/", def: "减轻", ex: "Mitigate the risk." },
            { word: "NOSTALGIA", pos: "n.", ipa: "/nɒˈstældʒə/", def: "怀旧", ex: "A sense of nostalgia." },
            { word: "OBSOLETE", pos: "adj.", ipa: "/ˈɒbsəliːt/", def: "过时的", ex: "Obsolete technology." },
            { word: "PRAGMATIC", pos: "adj.", ipa: "/præɡˈmætɪk/", def: "务实的", ex: "A pragmatic approach." },
            { word: "QUINTESSENTIAL", pos: "adj.", ipa: "/ˌkwɪntɪˈsenʃl/", def: "典型的", ex: "The quintessential gentleman." },
            { word: "SCRUTINIZE", pos: "v.", ipa: "/ˈskruːtənaɪz/", def: "详细检查", ex: "Scrutinize the document." },
            { word: "TRANSIENT", pos: "adj.", ipa: "/ˈtrænziənt/", def: "短暂的", ex: "Transient happiness." }
        ];

        const CHESS_LEVELS = [
            { id: 1, size: 4, grid: [[1,0,2,0],[0,0,1,0],[0,2,0,0],[3,0,0,1]], par: 6 },
            { id: 2, size: 5, grid: [[1,0,2,0,1],[0,0,4,0,0],[2,0,3,0,2],[0,0,4,0,0],[1,0,2,0,1]], par: 8 },
            { id: 3, size: 6, grid: [[0,1,0,0,1,0],[2,0,0,2,0,0],[0,0,4,4,0,0],[0,0,4,4,0,0],[0,2,0,0,2,0],[1,0,3,0,0,1]], par: 12 },
            { id: 4, size: 5, grid: [[3,0,0,0,1],[0,4,4,4,0],[0,4,1,4,0],[0,4,4,4,0],[1,0,0,0,0]], par: 10 },
            { id: 5, size: 4, grid: [[1,2,1,2],[0,0,0,0],[0,4,4,0],[3,0,0,0]], par: 7 },
            { id: 6, size: 5, grid: [[0,0,1,0,0],[0,2,2,2,0],[1,2,3,2,1],[0,2,2,2,0],[0,0,1,0,0]], par: 8 },
            { id: 7, size: 6, grid: [[3,0,0,0,0,0],[0,4,4,4,4,0],[0,0,0,0,0,0],[0,4,4,4,4,0],[0,0,0,0,0,0],[0,0,0,0,0,1]], par: 14 },
            { id: 8, size: 4, grid: [[2,1,2,1],[1,2,1,2],[2,1,3,1],[1,2,1,2]], par: 8 },
            { id: 9, size: 5, grid: [[1,0,0,0,1],[0,0,2,0,0],[0,2,3,2,0],[0,0,2,0,0],[1,0,0,0,1]], par: 8 },
            { id: 10, size: 5, grid: [[0,0,4,0,0],[0,1,4,1,0],[4,4,3,4,4],[0,1,4,1,0],[0,0,4,0,0]], par: 8 }
        ];

        const SUDOKU_LEVELS = [
            { id: 1, initial: [[1,0,0,4],[0,0,0,0],[0,0,0,0],[2,0,0,3]], solution: [[1,2,3,4],[3,4,1,2],[4,3,2,1],[2,1,4,3]] },
            { id: 2, initial: [[0,2,0,0],[3,0,0,2],[1,0,0,4],[0,0,0,0]], solution: [[4,2,3,1],[3,1,4,2],[1,3,2,4],[2,4,1,3]] },
            { id: 3, initial: [[0,0,0,0],[0,1,2,0],[0,3,4,0],[0,0,0,0]], solution: [[1,2,3,4],[4,1,2,3],[2,3,4,1],[3,4,1,2]] },
            { id: 4, initial: [[0,3,0,0],[1,0,0,0],[0,0,0,4],[0,0,2,0]], solution: [[2,3,4,1],[1,4,3,2],[3,2,1,4],[4,1,2,3]] },
            { id: 5, initial: [[4,0,0,0],[0,2,0,0],[0,0,3,0],[0,0,0,1]], solution: [[4,3,1,2],[1,2,4,3],[2,1,3,4],[3,4,2,1]] }
        ];

        const generateLevelSequence = () => {
            let wordPool = [...WORD_LIBRARY].sort(() => 0.5 - Math.random());
            const shuffledChess = [...CHESS_LEVELS].sort(() => 0.5 - Math.random());
            const shuffledSudoku = [...SUDOKU_LEVELS].sort(() => 0.5 - Math.random());
            
            const getUniqueWords = (count) => {
                if (wordPool.length < count) wordPool = [...WORD_LIBRARY].sort(() => 0.5 - Math.random());
                return wordPool.splice(0, count);
            };

            const generateOptions = (word) => {
                const correct = Array.from(new Set(word.split('')));
                const all = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
                let opts = [...correct];
                while(opts.length < Math.min(10, word.length + 3)) {
                    const r = all[Math.floor(Math.random() * 26)];
                    if(!opts.includes(r)) opts.push(r);
                }
                return opts.sort(() => 0.5 - Math.random());
            };

            const levels = [];
            // 20关配置: 6 x Chess, 4 x Sudoku, 10 x Word
            const gameTypes = [
                ...Array(6).fill('knight'),
                ...Array(4).fill('sudoku'),
                ...Array(10).fill('word_mix')
            ].sort(() => 0.5 - Math.random());

            gameTypes.forEach((type, i) => {
                if (type === 'knight') {
                    levels.push({ type: 'knight', data: { id: shuffledChess[i % shuffledChess.length].id } });
                } else if (type === 'sudoku') {
                    levels.push({ type: 'sudoku', data: shuffledSudoku[i % shuffledSudoku.length] });
                } else {
                    const rand = Math.random();
                    const words = getUniqueWords(rand < 0.4 ? 2 : 1);
                    if (rand < 0.4) {
                        levels.push({ type: 'scramble', data: { p1Word: words[0], p2Word: words[1] } });
                    } else {
                        levels.push({ type: 'word', data: { ...words[0], hintPattern: Array(words[0].word.length).fill(true).map(()=>Math.random()>0.45), options: generateOptions(words[0].word), startPlayer: i%2===0?1:2 } });
                    }
                }
            });

            const indices = Array.from({length: 20}, (_, k) => k);
            for (let i = indices.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [indices[i], indices[j]] = [indices[j], indices[i]];
            }
            const fragmentIndices = new Set(indices.slice(0, 5));
            
            return levels.map((lvl, idx) => ({ ...lvl, hasFragment: fragmentIndices.has(idx), index: idx }));
        };

        const HintPanel = ({ data, extraContent }) => {
            if (!data) return null;
            return (
                <div className="flex flex-col items-center justify-center h-full px-12 z-10 relative text-center">
                    <div className="bg-slate-800 p-8 rounded-3xl border border-yellow-500/20 shadow-2xl w-full max-w-lg">
                        <h3 className="text-sm text-yellow-500 mb-4 font-bold tracking-widest font-sans-custom">CLUE CARD</h3>
                        {!extraContent && (
                            <div className="text-5xl font-mono tracking-widest text-yellow-100 mb-6 font-bold opacity-90 break-words">
                                {data.word.split('').map((c, i) => data.hintPattern && data.hintPattern[i] ? c : "_").join(" ")}
                            </div>
                        )}
                        <div className="space-y-4 text-left bg-black/40 p-6 rounded-xl">
                            <div className="flex items-baseline gap-3">
                                <span className="text-yellow-400 text-xl font-bold italic">{data.pos}</span>
                                <span className="text-slate-400 text-lg font-serif">[{data.ipa}]</span>
                            </div>
                            <div className="text-2xl text-white font-proposal-cn leading-relaxed">{data.def}</div>
                            {extraContent}
                            <div className="text-slate-300 text-base italic font-sans-custom leading-relaxed border-t border-white/10 pt-3 mt-2">"{data.ex}"</div>
                        </div>
                    </div>
                </div>
            );
        };

        const GameInstruction = ({ text }) => (
            <div className="absolute top-2 w-full text-center pointer-events-none z-30">
                <span className="bg-black/60 text-yellow-300 text-lg px-6 py-2 rounded-full border border-yellow-500/30 backdrop-blur-md shadow-lg font-sans-custom tracking-wider">
                    <i className="ph-fill ph-info mr-2"></i>{text}
                </span>
            </div>
        );

        const UndoButton = ({ onUndo, disabled }) => (
            <button onClick={onUndo} disabled={disabled} className={`absolute bottom-10 left-10 px-6 py-3 bg-slate-700/90 text-white rounded-full z-40 border border-slate-500 transition-all flex items-center gap-2 text-lg font-bold shadow-lg ${disabled ? 'opacity-30' : 'opacity-100 active:scale-95'}`}>
                <i className="ph-bold ph-arrow-u-up-left text-xl"></i> 撤销
            </button>
        );

        const DebugButton = ({ onClick }) => (
            <button onClick={(e) => { e.stopPropagation(); onClick(); }} className="absolute bottom-10 right-10 px-6 py-3 bg-red-900/60 text-red-200 text-sm rounded-full z-50 border border-red-500/30 active:bg-red-600 active:text-white font-sans-custom hover:scale-105 transition-all backdrop-blur-sm">
                DEBUG
            </button>
        );

        const NextLevelButton = ({ onClick }) => (
            <div className="absolute bottom-32 left-1/2 transform -translate-x-1/2 z-50 animate-bounce">
                <button onClick={onClick} className="px-10 py-4 bg-green-600/90 text-white rounded-full text-2xl font-bold shadow-[0_0_30px_rgba(22,163,74,0.6)] backdrop-blur border-2 border-green-400 hover:scale-105 transition-transform">
                    进入下一关 &gt;&gt;
                </button>
            </div>
        );

        const HintButton = ({ hints, onHint }) => (
            <div className="flex flex-col items-center gap-1 group">
                <button onClick={onHint} className={`flex items-center justify-center transition-all ${hints <= 0 ? 'opacity-100 animate-pulse' : 'opacity-100 hover:scale-110 active:scale-95'}`}>
                    <i className={`ph-fill ph-lightbulb text-4xl drop-shadow-[0_0_15px_rgba(250,204,21,0.6)] ${hints > 0 ? 'text-yellow-400' : 'text-slate-500'}`}></i>
                </button>
                <div className="flex items-center gap-1">
                    <span className="text-xs text-yellow-200 font-sans-custom tracking-widest">HINT</span>
                    <span className={`text-sm font-bold ${hints > 0 ? 'text-white' : 'text-red-400'}`}>x{hints}</span>
                </div>
            </div>
        );

        const StarBackground = () => (
            <div className="absolute inset-0 z-0 pointer-events-none">
                <div className="stars"></div>
                <div className="twinkling"></div>
                <div className="absolute inset-0 bg-gradient-to-b from-slate-900/80 via-slate-900/60 to-slate-800/80"></div>
            </div>
        );

        const MoonDisplay = ({ progress, isFull, isRing, stage }) => {
            return (
                <div className={`relative w-full h-full flex items-center justify-center transition-all duration-1000`}>
                    
                    {/* Ring Base */}
                    <div className={`absolute w-full h-full flex items-center justify-center transition-opacity duration-1000 ${stage >= 3 ? 'opacity-100' : 'opacity-0'}`}>
                         <svg viewBox="0 0 100 100" className="w-80 h-80 drop-shadow-[0_0_30px_rgba(255,255,255,0.5)] overflow-visible">
                            <defs>
                                <linearGradient id="silverGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" stopColor="#e2e8f0" />
                                    <stop offset="50%" stopColor="#f8fafc" />
                                    <stop offset="100%" stopColor="#cbd5e1" />
                                </linearGradient>
                            </defs>
                            <circle cx="50" cy="65" r="28" fill="none" stroke="url(#silverGradient)" strokeWidth="6" />
                            <path d="M40 37 L40 28 L60 28 L60 37" fill="none" stroke="url(#silverGradient)" strokeWidth="3" />
                            <path d="M42 28 L50 32 L58 28" fill="none" stroke="url(#silverGradient)" strokeWidth="2" />
                        </svg>
                    </div>

                    {/* Moon/Diamond */}
                    <div className={`relative w-[500px] h-[500px] p-4 transition-all duration-[2000ms] ease-in-out
                        ${stage >= 2 ? 'scale-[0.22] -translate-y-24 z-10' : (isFull ? 'scale-110' : 'scale-90')}
                    `}>
                        <svg viewBox="0 0 100 100" className="w-full h-full drop-shadow-2xl moon-glow overflow-visible">
                            <defs>
                                <radialGradient id="moonGradient" cx="50%" cy="50%" r="50%" fx="30%" fy="30%">
                                    <stop offset="0%" stopColor="#fef08a" />
                                    <stop offset="90%" stopColor="#facc15" />
                                    <stop offset="100%" stopColor="#eab308" />
                                </radialGradient>
                                <filter id="glow">
                                    <feGaussianBlur stdDeviation="2.5" result="coloredBlur"/>
                                    <feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge>
                                </filter>
                            </defs>
                            <circle cx="50" cy="50" r="46" fill="url(#moonGradient)" filter="url(#glow)" />
                        </svg>
                        {stage >= 2 && (
                            <div className="absolute inset-0 bg-white/50 rounded-full animate-pulse blur-xl mix-blend-overlay"></div>
                        )}
                    </div>
                </div>
            );
        };

        const SuccessOverlay = () => (
            <div className="absolute inset-0 flex items-center justify-center z-50 pointer-events-none">
                <div className="bg-black/70 backdrop-blur-md px-12 py-6 rounded-2xl border border-green-500/50 shadow-2xl scale-in">
                    <h2 className="text-5xl font-bold text-green-400 font-proposal-en tracking-widest drop-shadow-[0_0_15px_rgba(74,222,128,0.8)]">SUCCESS!</h2>
                </div>
            </div>
        );

        const FragmentNotification = () => (
            <div className="absolute top-24 left-1/2 transform -translate-x-1/2 z-50 pointer-events-none animate-bounce">
                <div className="bg-yellow-900/90 backdrop-blur-md px-10 py-5 rounded-full border border-yellow-400 shadow-[0_0_40px_rgba(234,179,8,0.6)] flex items-center gap-4">
                    <div className="w-10 h-10 bg-yellow-400 rounded-full shadow-[0_0_15px_white]"></div>
                    <span className="text-2xl font-bold text-yellow-100 font-proposal-cn">获得月光碎片!</span>
                </div>
            </div>
        );

        const HintRefillGame = ({ onComplete }) => {
            const [score, setScore] = useState(0);
            const [timeLeft, setTimeLeft] = useState(33); 
            const [drops, setDrops] = useState([]);
            const dropIdRef = useRef(0);
            useEffect(() => { const t=setInterval(()=>setTimeLeft(v=>{if(v<=1){clearInterval(t);onComplete(Math.floor(score/10));return 0}return v-1}),1000); return ()=>clearInterval(t)},[score]);
            useEffect(() => { if(timeLeft>30)return; const s=setInterval(()=>{const id=dropIdRef.current++;setDrops(p=>[...p,{id,left:Math.random()*90+5,top:-10}]);setTimeout(()=>setDrops(p=>p.filter(d=>d.id!==id)),3000)},300); return ()=>clearInterval(s)},[timeLeft]);
            useEffect(() => { if(timeLeft>30)return; const a=setInterval(()=>setDrops(p=>p.map(d=>({...d,top:d.top+2}))),30); return ()=>clearInterval(a)},[timeLeft]);
            return <div className="absolute inset-0 z-[60] bg-black/90 flex flex-col items-center justify-center">{timeLeft>30?<div className="text-9xl text-yellow-400 animate-ping">{timeLeft-30}</div>:<><div className="absolute top-20 text-white text-center text-xl">收集光点! {score} (10=1提示)</div>{drops.map(d=><div key={d.id} onTouchStart={()=>setScore(s=>s+1)||setDrops(p=>p.filter(x=>x.id!==d.id))} onMouseDown={()=>setScore(s=>s+1)||setDrops(p=>p.filter(x=>x.id!==d.id))} className="absolute w-14 h-14 bg-yellow-200 rounded-full blur-md cursor-pointer" style={{left:d.left+'%',top:d.top+'%'}}></div>)}</>}</div>
        };

        const GameWordPuzzle = ({ data, onComplete, hintSignal }) => {
            if (!data) return null;
            const [selectedChars, setSelectedChars] = useState([]);
            const [feedback, setFeedback] = useState(""); 
            const [debugSolved, setDebugSolved] = useState(false);
            const isP1Controlling = data.startPlayer === 1;

            useEffect(() => {
                if(hintSignal > 0 && selectedChars.length < data.word.length) {
                    handleCharClick(data.word[selectedChars.length]);
                }
            }, [hintSignal]);

            const handleCharClick = (char) => {
                const newSelection = [...selectedChars, char];
                setSelectedChars(newSelection);
                if (newSelection.length === data.word.length) {
                    if (newSelection.join("") === data.word) {
                        setFeedback("correct");
                        onComplete();
                    } else {
                        setFeedback("wrong");
                        setTimeout(() => { setSelectedChars([]); setFeedback(""); }, 800);
                    }
                }
            };

            const debugSolve = () => {
                setSelectedChars(data.word.split(''));
                setFeedback("correct");
                setDebugSolved(true);
            };

            const ControlPanel = () => (
                <div className="flex flex-col items-center justify-center h-full px-8 z-10 relative">
                    <div className="bg-slate-800 p-8 rounded-3xl border border-white/10 shadow-2xl w-full max-w-lg">
                        <h3 className="text-lg text-green-400 mb-6 font-bold text-center tracking-widest font-sans-custom">SPELL THE WORD</h3>
                        <div className={`mb-8 h-16 flex items-center justify-center text-4xl font-bold tracking-[0.2em] border-b-2 transition-colors w-full font-serif ${feedback === 'wrong' ? 'border-red-500 text-red-400' : 'border-white/30'}`}>
                            {selectedChars.join(" ") || "..."}
                        </div>
                        <div className="grid grid-cols-5 gap-3">
                            {data.options.map((char, idx) => (
                                <button key={idx} onClick={() => handleCharClick(char)} className="w-16 h-16 bg-slate-700/50 hover:bg-slate-600 rounded-xl text-2xl font-bold border border-white/10 active:scale-95 transition-all">{char}</button>
                            ))}
                            <button className="w-16 h-16 bg-red-500/20 text-red-300 rounded-xl flex items-center justify-center text-2xl" onClick={() => setSelectedChars(prev => prev.slice(0, -1))}><i className="ph ph-backspace"></i></button>
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="flex w-full h-full relative">
                    <GameInstruction text={isP1Controlling ? "P1根据P2的提示拼写单词" : "P2根据P1的提示拼写单词"} />
                    <UndoButton onUndo={() => setSelectedChars(prev => prev.slice(0, -1))} disabled={selectedChars.length === 0} />
                    <DebugButton onClick={debugSolve} />
                    {debugSolved && <NextLevelButton onClick={onComplete} />}
                    <div className="w-1/2 border-r border-white/10 relative flex items-center justify-center">{isP1Controlling ? <ControlPanel /> : <HintPanel data={data} extraContent={<div className="flex gap-2 justify-center my-4">{data.word.split('').map((_,i)=><div key={i} className="w-8 h-1 bg-white/30 rounded"></div>)}</div>} />}</div>
                    <div className="w-1/2 relative flex items-center justify-center">{!isP1Controlling ? <ControlPanel /> : <HintPanel data={data} extraContent={<div className="flex gap-2 justify-center my-4">{data.word.split('').map((_,i)=><div key={i} className="w-8 h-1 bg-white/30 rounded"></div>)}</div>} />}</div>
                </div>
            );
        };

        const GameScramble = ({ data, onComplete, hintSignal }) => {
            if (!data) return null;
            const [p1Input, setP1Input] = useState([]);
            const [p2Input, setP2Input] = useState([]);
            const [p1Solved, setP1Solved] = useState(false);
            const [p2Solved, setP2Solved] = useState(false);
            const [p1Chars, setP1Chars] = useState([]);
            const [p2Chars, setP2Chars] = useState([]);
            const [debugSolved, setDebugSolved] = useState(false);

            useEffect(() => {
                setP1Chars(data.p1Word.word.split('').sort(() => 0.5 - Math.random()));
                setP2Chars(data.p2Word.word.split('').sort(() => 0.5 - Math.random()));
            }, [data]);

            useEffect(() => {
                if(hintSignal > 0) {
                    if(!p1Solved) setP1Input(prev => [...prev, data.p1Word.word[prev.length] || '']);
                    if(!p2Solved) setP2Input(prev => [...prev, data.p2Word.word[prev.length] || '']);
                }
            }, [hintSignal]);

            useEffect(() => {
                if(p1Input.join("") === data.p1Word.word) setP1Solved(true);
                else if(p1Input.length >= data.p1Word.word.length) setTimeout(() => setP1Input([]), 500);
                if(p2Input.join("") === data.p2Word.word) setP2Solved(true);
                else if(p2Input.length >= data.p2Word.word.length) setTimeout(() => setP2Input([]),500);
                if(p1Solved && p2Solved && !debugSolved) onComplete();
            }, [p1Input, p2Input, p1Solved, p2Solved]);

            const debugSolve = () => {
                setP1Input(data.p1Word.word.split(''));
                setP2Input(data.p2Word.word.split(''));
                setP1Solved(true);
                setP2Solved(true);
                setDebugSolved(true);
            };

            const ScrambleBoard = ({ wordObj, input, setInput, isSolved, chars, label }) => (
                <div className="flex flex-col items-center justify-center h-full px-8 relative">
                    <div className="absolute top-8 left-8 text-sm font-bold text-slate-500 font-sans-custom">{label}</div>
                    <div className="text-xl text-yellow-500 font-serif mb-2 flex gap-3 justify-center items-center">
                        <span>{wordObj.def}</span>
                        <span className="opacity-70 text-sm mt-1">[{wordObj.pos} {wordObj.ipa}]</span>
                    </div>
                    <div className="flex gap-2 mb-6">
                        {wordObj.word.split('').map((_, i) => <div key={i} className={`w-6 h-1.5 rounded-full ${input.length > i ? 'bg-green-500' : 'bg-white/20'}`}></div>)}
                    </div>
                    <div className={`text-4xl font-bold tracking-widest mb-10 border-b-4 p-4 min-h-[4rem] transition-colors ${isSolved ? 'text-green-400 border-green-500' : 'text-white border-slate-600'}`}>{input.join("")}</div>
                    <div className="flex flex-wrap gap-3 justify-center max-w-sm">
                        {chars.map((char, i) => (
                            <button key={i} onClick={() => setInput(prev => [...prev, char])} className="w-16 h-16 bg-slate-700 rounded-xl text-2xl font-bold active:scale-95 shadow-lg border-b-4 border-slate-900 hover:bg-slate-600">{char}</button>
                        ))}
                    </div>
                    {isSolved && <div className="absolute top-10 right-10 text-green-400 text-6xl"><i className="ph-fill ph-check-circle animate-bounce"></i></div>}
                </div>
            );

            return (
                <div className="flex w-full h-full relative">
                    <GameInstruction text="各自还原乱序单词，双人同步完成" />
                    <UndoButton onUndo={() => { setP1Input(p => p.slice(0, -1)); setP2Input(p => p.slice(0, -1)); }} disabled={p1Input.length === 0 && p2Input.length === 0} />
                    <DebugButton onClick={debugSolve} />
                    {debugSolved && <NextLevelButton onClick={onComplete} />}
                    <div className="w-1/2 border-r border-white/10"><ScrambleBoard wordObj={data.p1Word} input={p1Input} setInput={setP1Input} isSolved={p1Solved} chars={p1Chars} label="PLAYER 1" /></div>
                    <div className="w-1/2"><ScrambleBoard wordObj={data.p2Word} input={p2Input} setInput={setP2Input} isSolved={p2Solved} chars={p2Chars} label="PLAYER 2" /></div>
                </div>
            );
        };

        const GameStarKnight = ({ levelId = 1, onComplete, hintSignal }) => {
            const levelData = CHESS_LEVELS.find(l => l.id === levelId) || CHESS_LEVELS[0];
            const [knightPos, setKnightPos] = useState({r:0, c:0});
            const [history, setHistory] = useState([]);
            const [targetsLeft, setTargetsLeft] = useState(0);
            const [activeGrid, setActiveGrid] = useState([]);
            const [trapMsg, setTrapMsg] = useState(null);
            const [debugSolved, setDebugSolved] = useState(false);
            const [highlightTargets, setHighlightTargets] = useState(false);

            useEffect(() => {
                let start = {r:0, c:0};
                let tCount = 0;
                levelData.grid.forEach((row, r) => row.forEach((cell, c) => { if(cell===3) start={r,c}; if(cell===1) tCount++; }));
                setKnightPos(start); setHistory([]); setTargetsLeft(tCount); setActiveGrid(JSON.parse(JSON.stringify(levelData.grid)));
                setDebugSolved(false);
            }, [levelData]);

            useEffect(() => {
                if(hintSignal > 0) {
                    setHighlightTargets(true);
                    setTimeout(() => setHighlightTargets(false), 2000);
                }
            }, [hintSignal]);

            const debugSolve = () => {
                setTargetsLeft(0);
                setDebugSolved(true);
            };

            const handleMove = (r, c) => {
                if (trapMsg) return;
                const dr = Math.abs(knightPos.r - r), dc = Math.abs(knightPos.c - c);
                if (!((dr===2 && dc===1) || (dr===1 && dc===2))) return;
                const cell = activeGrid[r][c];
                if (cell === 4) return;
                
                setHistory(prev => [...prev, { pos: knightPos, grid: JSON.parse(JSON.stringify(activeGrid)), targets: targetsLeft }]);
                
                if (cell === 2) { 
                    const ng = [...activeGrid]; ng[r][c] = 2; setActiveGrid(ng); setKnightPos({r,c}); setTrapMsg({r,c});
                    setTimeout(() => {
                        let s={r:0,c:0}, t=0;
                        levelData.grid.forEach((rw,rr)=>rw.forEach((cl,cc)=>{if(cl===3)s={r:rr,c:cc};if(cl===1)t++;}));
                        setKnightPos(s); setHistory([]); setTargetsLeft(t); setActiveGrid(JSON.parse(JSON.stringify(levelData.grid))); setTrapMsg(null);
                    }, 1500);
                } else {
                    setKnightPos({r,c});
                    if(cell===1) {
                        const ng = [...activeGrid]; ng[r][c] = 0; setActiveGrid(ng);
                        if(targetsLeft-1 === 0 && !debugSolved) onComplete();
                        setTargetsLeft(t => t-1);
                    }
                }
            };

            const handleUndo = () => {
                if (history.length === 0) return;
                const lastState = history[history.length - 1];
                setKnightPos(lastState.pos);
                setActiveGrid(lastState.grid);
                setTargetsLeft(lastState.targets);
                setHistory(prev => prev.slice(0, -1));
            };

            const RadarBoard = () => (
                <div className="radar-board" style={{gridTemplateColumns: `repeat(${levelData.size}, 1fr)`}}>
                    {activeGrid.map((row, r) => row.map((cell, c) => {
                        const isK = r===knightPos.r && c===knightPos.c;
                        return <div key={`${r}-${c}`} className={`w-14 h-14 rounded flex items-center justify-center relative radar-cell`}>
                            {isK && <div className="w-4 h-4 bg-yellow-300 rounded-full my-piece-dot shadow-[0_0_10px_yellow]"></div>}
                            {cell===2 && <i className="ph-fill ph-skull text-red-500 text-3xl skull-jump drop-shadow-md"></i>}
                        </div>
                    }))}
                </div>
            );

            const PilotBoard = () => (
                <div className="pilot-board" style={{gridTemplateColumns: `repeat(${levelData.size}, 1fr)`}}>
                    {activeGrid.map((row, r) => row.map((cell, c) => {
                        const isK = r===knightPos.r && c===knightPos.c;
                        const isT = trapMsg && trapMsg.r===r && trapMsg.c===c;
                        const isStar = cell === 1;
                        return <div key={`${r}-${c}`} onClick={()=>handleMove(r,c)} className={`w-14 h-14 rounded flex items-center justify-center relative cursor-pointer active:scale-90 transition-transform pilot-cell ${cell===4?'bg-slate-600 border border-slate-500':''} ${highlightTargets && isStar ? 'ring-4 ring-yellow-400 bg-yellow-900/30' : ''}`}>
                            {isK && <i className="ph-fill ph-horse text-cyan-400 text-3xl drop-shadow-lg"></i>}
                            {isStar && !isK && <i className={`ph-fill ph-star text-yellow-400 text-xl ${highlightTargets ? 'animate-bounce' : ''}`}></i>}
                            {isT && <i className="ph-fill ph-skull text-white text-3xl animate-bounce"></i>}
                        </div>
                    }))}
                </div>
            );

            return <div className="flex w-full h-full relative">
                <GameInstruction text="骑士走日字 • 躲避陷阱 • 收集星星" />
                <UndoButton onUndo={handleUndo} disabled={history.length === 0} />
                <DebugButton onClick={debugSolve} />
                {debugSolved && <NextLevelButton onClick={onComplete} />}
                <div className="w-1/2 border-r border-white/10 flex flex-col items-center justify-center"><div className="text-lg text-slate-400 font-bold mb-4">PILOT (星星)</div><PilotBoard /></div>
                <div className="w-1/2 flex flex-col items-center justify-center"><div className="text-lg text-red-400 font-bold mb-4">RADAR (陷阱)</div><RadarBoard /></div>
            </div>;
        };

        const GameSudoku = ({ data, onComplete }) => {
            if(!data) return null;
            const [grid, setGrid] = useState([]);
            const [selectedCell, setSelectedCell] = useState(null); 
            const [debugSolved, setDebugSolved] = useState(false);
            
            useEffect(() => { setGrid(JSON.parse(JSON.stringify(data.initial))); setDebugSolved(false); }, [data]);

            const debugSolve = () => {
                setGrid(data.solution);
                setDebugSolved(true);
            };

            useEffect(() => {
                if(grid.length > 0) {
                    let full = true, correct = true;
                    for(let r=0; r<4; r++) for(let c=0; c<4; c++) { if(grid[r][c] === 0) full = false; else if(grid[r][c] !== data.solution[r][c]) correct = false; }
                    if(full && correct && !debugSolved) onComplete();
                }
            }, [grid]);

            const handleNumberInput = (num) => {
                if(!selectedCell) return;
                const {r, c} = selectedCell;
                if(data.initial[r][c] !== 0) return;
                const newGrid = [...grid];
                newGrid[r][c] = num;
                setGrid(newGrid);
            };

            return (
                <div className="flex w-full h-full relative z-10">
                    <GameInstruction text="P1选格子，P2填数字，共同完成4x4数独" />
                    <UndoButton onUndo={() => { if(selectedCell) handleNumberInput(0); }} disabled={!selectedCell} />
                    <DebugButton onClick={debugSolve} />
                    {debugSolved && <NextLevelButton onClick={onComplete} />}
                    <div className="w-1/2 border-r border-white/10 flex flex-col items-center justify-center relative">
                        <div className="grid grid-cols-4 gap-3 bg-slate-800 p-6 rounded-3xl shadow-2xl border border-white/10">
                            {grid.map((row, r) => row.map((val, c) => (
                                <div key={`${r}-${c}`} onClick={() => data.initial[r][c] === 0 && setSelectedCell({r, c})}
                                    className={`w-20 h-20 flex items-center justify-center text-4xl font-bold rounded-xl cursor-pointer transition-all ${data.initial[r][c] !== 0 ? 'bg-slate-700 text-slate-400' : 'bg-slate-600 text-white hover:bg-slate-500'} ${selectedCell?.r === r && selectedCell?.c === c ? 'ring-4 ring-yellow-400 z-10 scale-105' : ''} ${val !== 0 && val !== data.solution[r][c] ? 'text-red-400' : ''}`}>
                                    {val !== 0 ? val : ''}
                                </div>
                            )))}
                        </div>
                    </div>
                    <div className="w-1/2 flex flex-col items-center justify-center relative">
                        <div className="grid grid-cols-2 gap-6">
                            {[1, 2, 3, 4].map(num => <button key={num} onClick={() => handleNumberInput(num)} className="w-24 h-24 bg-blue-600 rounded-2xl text-5xl font-bold shadow-lg active:scale-95 hover:bg-blue-500 transition-colors border-b-4 border-blue-800">{num}</button>)}
                            <button onClick={() => handleNumberInput(0)} className="col-span-2 h-16 bg-red-900/50 rounded-xl text-xl text-red-200 border border-red-500/30 hover:bg-red-900/80 transition-colors">清除 / Clear</button>
                        </div>
                    </div>
                </div>
            );
        };

        const ProposalScreen = ({ onReplay }) => {
            const [stage, setStage] = useState(0); 
            const [ringFly, setRingFly] = useState(false);
            const [showModal, setShowModal] = useState(false);

            useEffect(() => {
                setTimeout(() => setStage(1), 1000); 
                setTimeout(() => setStage(2), 2500); 
                setTimeout(() => setStage(3), 3500); 
            }, []);

            const handleYes = () => {
                setRingFly(true);
                setTimeout(() => setShowModal(true), 1500);
            };

            return (
                <div className="absolute inset-0 bg-black z-50 flex overflow-hidden">
                    <StarBackground />
                    
                    <div className={`absolute w-full h-full flex items-center justify-center transition-transform duration-[1500ms] ease-in-out ${stage >= 1 ? '-translate-x-[25vw]' : ''}`}>
                        <div className={`relative ${ringFly ? 'animate-ring-fly' : ''}`}>
                            <MoonDisplay progress={1} isFull={true} isRing={false} stage={stage} />
                        </div>
                    </div>

                    <div className={`absolute right-0 top-0 w-1/2 h-full flex flex-col justify-center px-16 transition-opacity duration-1000 ${stage >= 3 ? 'opacity-100' : 'opacity-0'}`}>
                        <h1 className="text-5xl font-proposal-cn text-yellow-50 mb-8">{PROPOSAL_TEXT.title}</h1>
                        <div className="space-y-4 mb-12">
                            {PROPOSAL_TEXT.lines.map((line, i) => (
                                <div key={i} className="text-2xl text-slate-200 font-proposal-cn" style={{animation: stage >= 3 ? `fadeIn 1s ease-out ${i*0.5}s both` : 'none'}}>{line}</div>
                            ))}
                        </div>
                        <h2 className="text-4xl font-bold text-white mb-8 font-proposal-cn">{PROPOSAL_TEXT.question}</h2>
                        <button onClick={handleYes} className="px-12 py-4 bg-yellow-500 hover:bg-yellow-400 text-yellow-950 rounded-full text-2xl font-bold shadow-lg active:scale-95 transition-all font-proposal-en w-fit">YES, I DO</button>
                    </div>

                    {showModal && (
                        <div className="absolute inset-0 bg-black/80 flex items-center justify-center z-50 animate-fade-in">
                            <div className="bg-slate-900/90 p-12 rounded-3xl border border-yellow-500/50 flex flex-col items-center shadow-[0_0_50px_rgba(234,179,8,0.3)]">
                                <div className="w-48 h-48 mb-8 animate-bounce"><MoonDisplay progress={1} isFull={true} isRing={false} stage={3} /></div>
                                <h2 className="text-4xl text-yellow-400 font-proposal-cn mb-8">我也爱你!</h2>
                                <button onClick={onReplay} className="text-slate-400 hover:text-white border-b border-transparent hover:border-white transition-all">返回主页</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            const [gameStage, setGameStage] = useState("menu"); 
            const [levelData, setLevelData] = useState([]);
            const [currentLevelIndex, setCurrentLevelIndex] = useState(0);
            const [collectedFragments, setCollectedFragments] = useState(0);
            const [hintSignal, setHintSignal] = useState(0);
            const [hintsRemaining, setHintsRemaining] = useState(3);
            const [showHintGame, setShowHintGame] = useState(false);
            const [showSuccess, setShowSuccess] = useState(false);
            const [showFragment, setShowFragment] = useState(false);
            
            const startNewGame = () => {
                const levels = generateLevelSequence();
                setLevelData(levels);
                setCurrentLevelIndex(0);
                setCollectedFragments(0);
                setHintsRemaining(3);
                setGameStage("playing");
            };

            const triggerHint = () => {
                if(hintsRemaining > 0) { setHintSignal(s => s + 1); setHintsRemaining(h => h - 1); } else { setShowHintGame(true); }
            };

            const handleHintGameComplete = (earned) => {
                setHintsRemaining(h => h + earned);
                setShowHintGame(false);
            };

            const handleGameComplete = () => {
                setShowSuccess(true);
                setHintSignal(0);
                
                const currentLevel = levelData[currentLevelIndex];
                if (currentLevel.hasFragment) {
                    setCollectedFragments(prev => Math.min(5, prev + 1));
                    setShowFragment(true);
                    setTimeout(() => setShowFragment(false), 2000);
                }

                setTimeout(() => {
                    setShowSuccess(false);
                    setHintsRemaining(3); 
                    
                    if (currentLevelIndex + 1 < levelData.length) {
                        setCurrentLevelIndex(prev => prev + 1);
                    } else {
                        setGameStage("ending");
                    }
                }, 1500);
            };

            const [isLandscape, setIsLandscape] = useState(window.innerWidth > window.innerHeight);
            const [devBypass, setDevBypass] = useState(false);
            useEffect(() => {
                const check = () => setIsLandscape(window.innerWidth > window.innerHeight);
                window.addEventListener('resize', check);
                return () => window.removeEventListener('resize', check);
            }, []);

            if (!isLandscape && !devBypass) {
                return (
                    <div className="w-screen h-screen bg-black flex flex-col items-center justify-center text-white p-8 text-center font-sans-custom">
                        <i className="ph ph-device-rotate text-6xl mb-4 animate-spin-slow"></i>
                        <h2 className="text-xl mb-8">请旋转 iPad 至横屏模式</h2>
                        <button onClick={() => setDevBypass(true)} className="px-4 py-2 border border-white/20 text-xs rounded opacity-50 hover:opacity-100">我是电脑 (强制进入)</button>
                    </div>
                );
            }

            const currentLevel = levelData[currentLevelIndex];

            return (
                <div className="w-screen h-screen flex flex-col overflow-hidden relative">
                    <StarBackground />
                    {/* Centered Main Menu Layout Fix */}
                    {gameStage === "menu" ? (
                        <div className="absolute inset-0 flex flex-col items-center justify-center z-50 gap-6">
                             {/* Moon Container */}
                            <div className="relative w-80 h-80 flex items-center justify-center">
                                 <MoonDisplay progress={0} isFull={false} isRing={false} stage={0} />
                            </div>
                            
                            {/* Text & Button Container */}
                            <div className="flex flex-col items-center gap-6">
                                <div className="text-center">
                                    <h1 className="text-7xl text-yellow-400 tracking-tighter font-serif font-bold drop-shadow-[0_0_20px_rgba(250,204,21,0.4)] mb-2">Moonlight Mosaic</h1>
                                    <p className="text-slate-300 text-2xl font-proposal-cn tracking-[0.2em] opacity-80">双人 · 协作 · 永恒</p>
                                </div>
                                
                                <button onClick={startNewGame} className="px-12 py-5 border-2 border-yellow-500/50 bg-yellow-500/10 text-yellow-300 rounded-full hover:bg-yellow-500/20 hover:border-yellow-400 hover:text-white hover:scale-105 transition-all duration-300 text-2xl tracking-widest font-sans-custom backdrop-blur-sm shadow-[0_0_30px_rgba(234,179,8,0.2)]">
                                    START GAME
                                </button>
                            </div>
                        </div>
                    ) : (
                        // Game Layout
                        <>
                            <div className="border-b border-white/5 flex items-center justify-between px-8 bg-slate-900/50 backdrop-blur z-20 shrink-0 box-content" style={{height: '2.5rem', paddingTop: 'env(safe-area-inset-top)'}}>
                                <div className="text-slate-400 text-xs font-bold tracking-widest font-sans-custom">MOONLIGHT MOSAIC</div>
                                <div className="absolute left-1/2 transform -translate-x-1/2 flex items-center gap-4" style={{top: 'calc(env(safe-area-inset-top) + 0.2rem)'}}>
                                    <div className="flex gap-1">
                                        {[...Array(5)].map((_, i) => (
                                            <div key={i} className={`w-4 h-4 rounded-full ${i < collectedFragments ? 'bg-yellow-400 shadow-[0_0_10px_rgba(250,204,21,0.8)]' : 'bg-slate-700 border border-slate-600'}`}></div>
                                        ))}
                                    </div>
                                    {gameStage === 'playing' && <HintButton hints={hintsRemaining} onHint={triggerHint} />}
                                </div>
                                <div className="flex gap-4 items-center">
                                    {currentLevel && <div className="text-slate-300 text-[10px] font-sans-custom px-2 py-0.5 bg-white/5 rounded">Level {currentLevelIndex + 1}/{levelData.length}</div>}
                                </div>
                            </div>

                            <div className="flex-1 relative w-full h-full overflow-hidden">
                                {gameStage === "chapter_complete" && (
                                    <div className="absolute inset-0 flex flex-col items-center justify-center z-40 bg-slate-900/60 backdrop-blur-md transition-all duration-500">
                                        <div className="text-4xl text-yellow-300 mb-4 font-proposal-en animate-bounce font-bold">Chapter Complete</div>
                                        <div className="shard-animate"><MoonDisplay progress={moonProgress} isFull={moonProgress >= 0.99} isRing={false} stage={0} /></div>
                                    </div>
                                )}

                                {gameStage === "playing" && currentLevel && (
                                    <div className="w-full h-full relative">
                                        {showSuccess && <SuccessOverlay />}
                                        {showFragment && <FragmentNotification />}
                                        {showHintGame && <HintRefillGame onComplete={handleHintGameComplete} />}
                                        {currentLevel.type === 'word' && <GameWordPuzzle key={`lvl-${currentLevelIndex}`} data={currentLevel.data} onComplete={handleGameComplete} hintSignal={hintSignal} />}
                                        {currentLevel.type === 'scramble' && <GameScramble key={`lvl-${currentLevelIndex}`} data={currentLevel.data} onComplete={handleGameComplete} hintSignal={hintSignal} />}
                                        {currentLevel.type === 'knight' && <GameStarKnight key={`lvl-${currentLevelIndex}`} levelId={currentLevel.data.id} onComplete={handleGameComplete} hintSignal={hintSignal} />}
                                        {currentLevel.type === 'sudoku' && <GameSudoku key={`lvl-${currentLevelIndex}`} data={currentLevel.data} onComplete={handleGameComplete} />}
                                    </div>
                                )}

                                {gameStage === "ending" && <ProposalScreen onReplay={() => setGameStage("menu")} />}
                            </div>
                        </>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
